---
- name: Attach Store Diagnostic Report to ServiceNow Incident
  hosts: localhost
  gather_facts: false
  roles:
    - Output

  tasks:
    - name: Import tasks
      ansible.builtin.include_tasks: "{{ item }}"
      loop:
        - tasks/snow_attach_store_diagnostic_report/servicenow.yml
        - tasks/snow_attach_store_diagnostic_report/store_switch.yml
        - tasks/snow_attach_store_diagnostic_report/rocklin_mpls_router.yml
        - tasks/snow_attach_store_diagnostic_report/firewall.yml
        - tasks/snow_attach_store_diagnostic_report/vmanage.yml
        - tasks/snow_attach_store_diagnostic_report/mist.yml

  post_tasks:
    - name: Render diagnostic report
      ansible.builtin.template:
        src: templates/snow_attach_store_diagnostic_report.j2
        dest: "{{ output_dir }}/{{ snow_incident | lower }}_store_diagnostic_report_{{ timestamp }}.txt"

    - name: Attach diagnostic report to incident
      servicenow.itsm.incident:
        instance:
          host: "{{ snow_instance }}"
          username: "{{ snow_username }}"
          password: "{{ snow_password }}"
        number: "{{ snow_incident }}"
        attachments:
          - path: "{{ output_dir }}/{{ snow_incident | lower }}_store_diagnostic_report_{{ timestamp }}.txt"

    - name: Set work_notes fact
      ansible.builtin.set_fact:
        work_notes: |
          <h3>Store Analysis</h3>
          {% set issue = namespace(found = false) %}
          Store Switch:<br />
          {% if not store_switch_ping.stderr | default("failed") %}
          {% set store_switch_pingable = true if store_switch_ping.stdout | regex_search("Success rate is [1-9]", multiline=False, ignorecase=False) else false %}
          {% if store_switch_pingable %}
            Pingable: Yes<br />
          {% else %}
          {% set issue.found = true %}
            Pingable: No 🔴<br />
          {% endif %}
          {% else %}
          {% set store_switch_pingable = false %}
          {% set issue.found = true %}
            Pingable: N/A 🔴<br />
          {% endif %}
          {% if not store_switch_uptime.stderr | default("failed") %}
            Uptime: {{ store_switch_uptime.stdout_lines[5] | regex_replace("^.+uptime is ", "") }}<br />
          {% else %}
          {% set issue.found = true %}
            Uptime: N/A 🔴<br />
          {% endif %}
          Store Router:<br />
          {% if not store_router_ping.stderr | default("failed") %}
          {% set store_router_pingable = true if store_router_ping.stdout | regex_search("Success rate is [1-9]", multiline=False, ignorecase=False) else false %}
          {% if store_router_pingable %}
            Pingable: Yes<br />
          {% else %}
          {% set issue.found = true %}
            Pingable: No 🔴<br />
          {% endif %}
          {% else %}
          {% set store_router_pingable = false %}
          {% set issue.found = true %}
            Pingable: N/A 🔴<br />
          {% endif %}
          {% if not store_subnet_lookup.stderr | default("failed") %}
          {% if store_subnet_lookup.stdout_lines[5] | regex_search(store_subnet, multiline=False, ignorecase=False) %}
          MPLS Path: Up<br />
          {% else %}
          {% set issue.found = true %}
          MPLS Path: Down 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          MPLS Path: N/A 🔴<br />
          {% endif %}
          {% if not sdwan_store %}
          {% if not store_bb_tunnel_status.stderr | default("failed") %}
          {% set bb_tunnel_up = true if store_bb_tunnel_status.stdout | regex_search("prefixes\s[1-9]\d*\s*$", multiline=False, ignorecase=False) else false %}
          {% if bb_tunnel_up %}
          Broadband Tunnel: Up<br />
          {% else %}
          {% set issue.found = true %}
          Broadband Tunnel: Down 🔴<br />
          {% endif %}
          {% else %}
          {% set bb_tunnel_up = false %}
          {% set issue.found = true %}
          Broadband Tunnel: N/A 🔴<br />
          {% endif %}
          {% endif %}
          {% if not store_internet_egress.stderr | default("failed") %}
          {% if store_internet_egress.stdout | regex_search("8.8.8.8.+msec", multiline=False, ignorecase=False) or store_switch_connect_ws_site.stdout | regex_search("Open", multiline=False, ignorecase=False) %}
          Internet Reachable: Yes<br />
          {% else %}
          {% set issue.found = true %}
          Internet Reachable: No 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          Internet Reachable: N/A 🔴<br />
          {% endif %}
          {% if not store_internet_egress.stderr | default("failed") %}
          {% if store_internet_egress.stdout | regex_search("asgi1", multiline=False, ignorecase=False) %}
          Internet Egress: Ashburn<br />
          {% elif store_internet_egress.stdout | regex_search("rkat1", multiline=False, ignorecase=False)  %}
          Internet Egress: Rocklin<br />
          {% elif store_internet_egress.stdout | regex_search("sast1", multiline=False, ignorecase=False)  %}
          Internet Egress: Sacramento<br />
          {% else %}
          {% set issue.found = true %}
          Internet Egress: Unknown 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          Internet Egress: N/A 🔴<br />
          {% endif %}
          {% if not store_switch_dns_test.stderr | default("failed") %}
          {% if store_switch_dns_test.stdout | regex_search("Translating.+domain\sserver\s\(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\)\s\[OK\]", multiline=False, ignorecase=False) %}
          DNS Resolution Functional: Yes<br />
          {% else %}
          {% set issue.found = true %}
          DNS Resolution Functional: No 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          DNS Resolution Functional: N/A 🔴<br />
          {% endif %}
          {% if not store_switch_connect_ws_site.stderr | default("failed") %}
          {% if store_switch_connect_ws_site.stdout | regex_search("Open", multiline=False, ignorecase=False) %}
          Williams Sonoma Site (williams-sonoma.com) Reachable: Yes<br />
          {% else %}
          {% set issue.found = true %}
          Williams Sonoma Site (williams-sonoma.com) Reachable: No 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          Williams Sonoma Site (williams-sonoma.com) Reachable: N/A 🔴<br />
          {% endif %}
          {% if not store_switch_connect_storesweb.stderr | default("failed") %}
          {% if store_switch_connect_storesweb.stdout | regex_search("Open", multiline=False, ignorecase=False) %}
          Store Wide Web Site ({{ storesweb_fqdn }}) Reachable: Yes<br />
          {% else %}
          {% set issue.found = true %}
          Store Wide Web Site ({{ storesweb_fqdn }}) Reachable: No 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          Store Wide Web Site ({{ storesweb_fqdn }}) Reachable: N/A 🔴<br />
          {% endif %}
          {% if not store_switch_connect_verifone.stderr | default("failed") %}
          {% if store_switch_connect_verifone.stdout | regex_search("Open", multiline=False, ignorecase=False) %}
          Verifone API (api.vfipayna.com) Reachable: Yes<br />
          {% else %}
          {% set issue.found = true %}
          Verifone API (api.vfipayna.com) Reachable: No 🔴<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
          Verifone API (api.vfipayna.com) Reachable: N/A 🔴<br />
          {% endif %}
          Verifone active firewall sessions:<br />
          {% if not active_verifone_sessions_ashburn.stderr | default("failed") %}
            Ashburn: {{ active_verifone_sessions_ashburn.stdout_lines | length - 1 }}<br />
          {% else %}
          {% set issue.found = true %}
            Ashburn: N/A 🔴<br />
          {% endif %}
          {% if not active_verifone_sessions_rocklin.stderr | default("failed") %}
            Rocklin: {{ active_verifone_sessions_rocklin.stdout_lines | length - 1 }}<br />
          {% else %}
          {% set issue.found = true %}
            Rocklin: N/A 🔴<br />
          {% endif %}
          {% if not active_verifone_sessions_sacramento.stderr | default("failed") %}
            Sacramento: {{ active_verifone_sessions_sacramento.stdout_lines | length - 1 }}<br />
          {% else %}
          {% set issue.found = true %}
            Sacramento: N/A 🔴<br />
          {% endif %}
          {% if sdwan_store %}
          {% set sessions = { "private": { "count": 0, "down": 0 }, "internet": { "count": 0, "down": 0 } } %}
          Cisco SD-WAN:<br />
            Tunnel Status:<br />
          {% if asbc1_hub_1_sessions.json.data | default("") %}
              Ashburn Hub Router:<br />
          {% for s in asbc1_hub_1_sessions.json.data %}
          {% set session_type = s["local-color"] | regex_replace("(\d$)|(^biz-)", "") %}
          {% if sessions[session_type].update({ "count": sessions[session_type]["count"] + 1 })  %}{% endif %}
          {% if s.state == "up" %}
                {{ s["local-color"] | title }}: Up<br />
          {% else %}
          {% set issue.found = true %}
                {{ s["local-color"] | title }}: Down 🔴<br />
          {% if sessions[session_type].update({ s.state: sessions[session_type][s.state] + 1 })  %}{% endif %}
          {% endif %}
          {% endfor %}
          {% else %}
          {% set issue.found = true %}
              Ashburn Hub Router: N/A 🔴<br />
          {% endif %}
          {% if rkat1_hub_1_sessions.json.data | default("") %}
              Rocklin Hub Router 1:<br />
          {% for s in rkat1_hub_1_sessions.json.data %}
          {% set session_type = s["local-color"] | regex_replace("(\d$)|(^biz-)", "") %}
          {% if sessions[session_type].update({ "count": sessions[session_type]["count"] + 1 })  %}{% endif %}
          {% if s.state == "up" %}
                {{ s["local-color"] | title }}: Up<br />
          {% else %}
          {% set issue.found = true %}
                {{ s["local-color"] | title }}: Down 🔴<br />
          {% if sessions[session_type].update({ s.state: sessions[session_type][s.state] + 1 })  %}{% endif %}
          {% endif %}
          {% endfor %}
          {% else %}
          {% set issue.found = true %}
              Rocklin Hub Router 1: N/A 🔴<br />
          {% endif %}
          {% if rkat1_hub_2_sessions.json.data | default("") %}
              Rocklin Hub Router 2:<br />
          {% for s in rkat1_hub_2_sessions.json.data %}
          {% set session_type = s["local-color"] | regex_replace("(\d$)|(^biz-)", "") %}
          {% if sessions[session_type].update({ "count": sessions[session_type]["count"] + 1 })  %}{% endif %}
          {% if s.state == "up" %}
                {{ s["local-color"] | title }}: Up<br />
          {% else %}
          {% set issue.found = true %}
                {{ s["local-color"] | title }}: Down 🔴<br />
          {% if sessions[session_type].update({ s.state: sessions[session_type][s.state] + 1 })  %}{% endif %}
          {% endif %}
          {% endfor %}
          {% else %}
          {% set issue.found = true %}
              Rocklin Hub Router 2: N/A 🔴<br />
          {% endif %}
          {% if tloc_stats.json.data | default("") %}
            TLOC Stats (Past Hour):<br />
          {% set remote_colors =  [ "biz-internet", "private1", "private2" ] %}
          {% set properties =  [ "Jitter", "Latency", "Loss_Percentage", "vQoE_Score" ] %}
          {% for c in remote_colors %}
              {{ c | title }}:<br />
          {% for p in properties %}
          {% set stats =  tloc_stats.json.data | selectattr("remote_color", "equalto", c) | map(attribute=p | lower) | list %}
          {% set stats_count = stats | length %}
          {% if stats_count > 0 %}
          {% set stats_mean = "%.2f" | format(stats | sum / stats_count) %}
          {% if p == "vQoE_Score" and stats_mean | int <= 5 %}
          {% set issue.found = true %}
                {{ p | replace("_", " ") }}: {{ stats_mean }} 🔴<br />
          {% else %}
                {{ p | replace("_", " ") }}: {{ stats_mean }}<br />
          {% endif %}
          {% else %}
          {% set issue.found = true %}
                {{ p | replace("_", " ") }}: N/A 🔴<br />
          {% endif %}
          {% endfor %}
          {% endfor %}
          {% else %}
          {% set issue.found = true %}
            TLOC Stats (Past Hour): N/A 🔴<br />
          {% endif %}
          {% endif %}
          {% if mist_store %}
          Mist Wireless:<br />
          {% if mist_site_stats.json | default("") %}
            Site: {{ mist_site_stats.json.name }}<br />
          {% if mist_site_stats.json.num_ap_connected == mist_site_stats.json.num_ap %}
            Connected APs: {{ mist_site_stats.json.num_ap_connected }}/{{ mist_site_stats.json.num_ap }}<br />
          {% else %}
          {% set issue.found = true %}
            Connected APs: {{ mist_site_stats.json.num_ap_connected }}/{{ mist_site_stats.json.num_ap }} 🔴<br />
          {% endif %}
            Connected Clients: {{ mist_site_stats.json.num_clients }}<br />
          {% else %}
          {% set issue.found = true %}
            Site: N/A 🔴<br />
            Connected APs: N/A 🔴<br />
            Connected Clients: N/A 🔴<br />
          {% endif %}
          {% if mist_wlans.json | default("") %}
            SSIDs:<br />
          {% for wlan in mist_wlans.json %}
              {{ wlan.ssid }}:<br />
                Enabled: {% if wlan.enabled %}Yes{% else %}No{% endif %}<br />
                Connected Clients: {{ mist_client_stats.json | selectattr('ssid', 'match', wlan.ssid) | length }}<br />
          {% endfor %}
          {% else %}
          {% set issue.found = true %}
            SSIDs: N/A 🔴<br />
          {% endif %}
          {% if mist_client_stats.json | default("") %}
          {% set rssi =  mist_client_stats.json | map(attribute='rssi') | sort %}
            RSSI:<br />
              Best: {% if rssi[-1] | int > -70 %}{{ rssi[-1] }}{% else %}{{ rssi[-1] }} 🔴{% set issue.found = true %}{% endif %}<br />
              Worst: {% if rssi[0] | int > -70 %}{{ rssi[0] }}{% else %}{{ rssi[0] }} 🔴{% endif %}<br />
              Median: {% if rssi[rssi | length // 2] | int > -70 %}{{ rssi[rssi | length // 2] }}{% else %}{{ rssi[rssi | length // 2] }} 🔴{% endif %}<br />
              Top 5 Worst:<br />
          {% for c in (mist_client_stats.json | sort(attribute="rssi"))[:5] %}
          {% if c.hostname | default("") and c.hostname | default("") != "\"\"" %}
                {{ c.ip | default("0.0.0.0") }} ({{ c.hostname }}):<br />
          {% else %}
                {{ c.ip | default("0.0.0.0") }}:<br />
          {% endif %}
                  RSSI: {% if c.rssi | int > -70 %}{{ c.rssi }}{% else %}{{ c.rssi }} 🔴{% endif %}<br />
                  SNR: {% if c.snr | int > 25 %}{{ c.snr }}{% else %}{{ c.snr }} 🔴{% endif %}<br />
                  SSID: {{ c.ssid }}<br />
                  Channel: {{ c.channel }}<br />
                  MAC Address: {{ c.mac }}<br />
                  Username: {{ c.username | default("") }}<br />
          {% endfor %}
          {% else %}
          {% set issue.found = true %}
            RSSI: N/A 🔴<br />
          {% endif %}
          {% endif %}
          <br />
          <h3>Recommended Next Steps</h3>
          {% set sdwan_private_down = true if sdwan_store and
                                                  (sessions.private.count > 0 and
                                                  sessions.private.count == sessions.private.down) else false %}
          {% set sdwan_internet_down = true if sdwan_store and
                                                  (sessions.internet.count > 0 and
                                                  sessions.internet.count == sessions.internet.down) else false %}
          {% set store_reachable = true if store_switch_pingable and store_router_pingable else false %}
          {% if not store_reachable or
                  sdwan_private_down or
                  sdwan_internet_down or
                  (not sdwan_store and not bb_tunnel_up) %}
          {# Specific recommendations #}
          {# Store connectivity #}
          {% if not store_reachable %}
          {# If the store router and switch are not pingable #}
          ⏺ Store is not reachable, call the store MOD to verify power<br />
          {% elif sdwan_store %}
          {% if sdwan_private_down %}
          ⏺ All SD-WAN private tunnels are down, confirm that a Verizon support case was auto created and update the incident with the details<br />
          {% endif %}
          {% if sdwan_internet_down %}
          ⏺ All SD-WAN internet tunnels are down, open a ticket with Granite and update the incident with the details<br />
          {% endif %}
          {% else %}
          {% if not bb_tunnel_up %}
          {# Else if no SD-WAN and broadband tunnel is down #}
          ⏺ Broadband tunnel is down, open a ticket with Granite and update the incident with the details<br />
          {% endif %}
          {% endif %}
          {# General recommendation #}
          ⏺ Review all issues in the above Store Analysis section<br />
          {% elif issue.found %}
          {# General recommendation when an issue is detected #}
          ⏺ Review all issues in the above Store Analysis section<br />
          {% else %}
          {# Default recommendation #}
          ⏺ Look for latency issues in the attached diagnostic report<br />
          {% endif %}

    - name: Update incident work notes
      servicenow.itsm.incident:
        instance:
          host: "{{ snow_instance }}"
          username: "{{ snow_username }}"
          password: "{{ snow_password }}"
        number: "{{ snow_incident }}"
        other:
          work_notes: |
            [code]<pre style="background-color: transparent; border-width: 0">[/code]
            [code]{{ work_notes }}[/code]
            [code]</pre>[/code]
